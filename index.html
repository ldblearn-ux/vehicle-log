<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ລະບົບເກັບກຳຂໍ້ມູນການນຳໃຊ້ລົດ (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans Lao', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-blue-800 flex items-center gap-2">
                    Vehicle Log Bookຕິດຕາມນຳໃຊ້ລົດ
                    <span id="sync-status" class="text-xs font-normal bg-blue-100 text-blue-700 px-2 py-1 rounded">Syncing...</span>
                </h1>
                <p class="text-gray-500">ລະບົບຕິດຕາມການນຳໃຊ້ລົດ ແລະ ຄິດໄລ່ນ້ຳມັນ (Cloud)</p>
            </div>
            <div class="text-right">
                <span id="current-date" class="text-sm font-medium text-gray-600 block"></span>
                <span id="user-id-display" class="text-[10px] text-gray-400">UID: Loading...</span>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="card p-6 border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm">ຖ້ຽວລົດທັງໝົດ</p>
                <h2 id="total-trips" class="text-3xl font-bold text-gray-800">0</h2>
            </div>
            <div class="card p-6 border-l-4 border-green-500">
                <p class="text-gray-500 text-sm">ໄລຍະທາງລວມ (km)</p>
                <h2 id="total-km" class="text-3xl font-bold text-gray-800">0</h2>
            </div>
            <div class="card p-6 border-l-4 border-orange-500">
                <p class="text-gray-500 text-sm">ເຕີມນ້ຳມັນ (ຄັ້ງ)</p>
                <h2 id="total-fuel-events" class="text-3xl font-bold text-gray-800">0</h2>
            </div>
            <div class="card p-6 border-l-4 border-red-500">
                <p class="text-gray-500 text-sm">ປະລິມານນ້ຳມັນລວມ (L)</p>
                <h2 id="total-fuel-liters" class="text-3xl font-bold text-gray-800">0</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Form Section -->
            <div class="lg:col-span-1">
                <div class="card p-6 sticky top-8 border border-blue-50">
                    <h3 class="text-lg font-bold mb-4 text-gray-700 flex items-center justify-between">
                        ບັນທຶກຂໍ້ມູນ
                        <div id="form-loader" class="hidden loading-spinner"></div>
                    </h3>
                    <form id="logForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ເລືອກລົດ</label>
                            <select id="vehicle" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 focus:ring-blue-500 focus:border-blue-500 border">
                                <option value="">-- ເລືອກລົດ --</option>
                                <option value="ລົດ ລີໂວ້ 3999" data-rate="10" data-fuel="ກາຊວນ">ລົດ ລີໂວ້ 3999</option>
                                <option value="ລົດປາໂດ້ 3999" data-rate="10" data-fuel="ກາຊວນ">ລົດປາໂດ້ 3999</option>
                                <option value="ລົດຕູ້ ຮຮ 3999" data-rate="10" data-fuel="ກາຊວນ">ລົດຕູ້ ຮຮ 3999</option>
                                <option value="ລົດຕູ້ 7150" data-rate="10" data-fuel="ກາຊວນ">ລົດຕູ້ 7150</option>
                                <option value="ລົດລີໂວ້ 1294" data-rate="10" data-fuel="ກາຊວນ">ລົດລີໂວ້ 1294</option>
                                <option value="ລົດ ລີໂວ້ ລອ3999" data-rate="10" data-fuel="ກາຊວນ">ລົດ ລີໂວ້ ລອ3999</option>
                                <option value="ລົດສ່ວນຕົວ" data-rate="13" data-fuel="ແອັດຊັງ">ລົດສ່ວນຕົວ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ຊື່ຜູ້ຂັບ</label>
                            <input type="text" id="driver" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ຈຸດປະສົງ</label>
                            <input type="text" id="purpose" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 border">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ກິໂລເລີ່ມ</label>
                                <input type="number" id="kmStart" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 border">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ກິໂລສິ້ນສຸດ</label>
                                <input type="number" id="kmEnd" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 border">
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="refuel" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="refuel" class="ml-2 block text-sm text-gray-700 font-bold text-orange-600">ມີການເຕີມນ້ຳມັນ</label>
                        </div>
                        <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition disabled:opacity-50">
                            ບັນທຶກລົງ Cloud
                        </button>
                    </form>
                </div>
            </div>

            <!-- Table Section -->
            <div class="lg:col-span-3">
                <div class="card p-6 overflow-hidden min-h-[400px]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-700">ປະຫວັດການນຳໃຊ້</h3>
                        <div class="flex gap-2">
                            <button onclick="exportData()" class="text-sm bg-green-100 text-green-700 px-3 py-1 rounded-md hover:bg-green-200">Export CSV</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ວັນທີ</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ຂໍ້ມູນລົດ / ຜູ້ຂັບ</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ໄລຍະທາງ</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ນ້ຳມັນ (ຄາດຄະເນ)</th>
                                    <th class="px-4 py-3 text-right"></th>
                                </tr>
                            </thead>
                            <tbody id="logList" class="divide-y divide-gray-100">
                                <!-- Data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="loadingLogs" class="flex justify-center py-20">
                        <div class="loading-spinner w-8 h-8"></div>
                    </div>
                    <div id="emptyState" class="text-center py-10 text-gray-400 hidden">
                        ຍັງບໍ່ມີຂໍ້ມູນການບັນທຶກ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl translate-y-20 transition-transform duration-300 ease-in-out">
        ບັນທຶກສຳເລັດ!
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vehicle-log-v3-fuel';

        let user = null;
        let logs = [];

        const init = async () => {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('lo-LA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { console.error(error); }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) setupRealtimeListener();
        });

        function setupRealtimeListener() {
            if (!user) return;
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'vehicle_logs');
            onSnapshot(collectionRef, (snapshot) => {
                logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                logs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                renderLogs();
                updateStats();
                document.getElementById('loadingLogs').classList.add('hidden');
                document.getElementById('sync-status').innerText = 'Cloud Synced';
            }, (error) => { console.error(error); });
        }

        document.getElementById('logForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!user) return;

            const vehicleSelect = document.getElementById('vehicle');
            const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
            const fuelRate = parseFloat(selectedOption.getAttribute('data-rate'));
            const fuelType = selectedOption.getAttribute('data-fuel');
            
            const kmStart = parseInt(document.getElementById('kmStart').value);
            const kmEnd = parseInt(document.getElementById('kmEnd').value);
            const distance = kmEnd - kmStart;
            
            // Calculate fuel: distance / rate
            const fuelUsed = distance / fuelRate;

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;

            try {
                const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'vehicle_logs');
                await addDoc(collectionRef, {
                    vehicle: vehicleSelect.value,
                    fuelType: fuelType,
                    fuelRate: fuelRate,
                    driver: document.getElementById('driver').value,
                    purpose: document.getElementById('purpose').value,
                    kmStart: kmStart,
                    kmEnd: kmEnd,
                    distance: distance,
                    fuelUsed: fuelUsed,
                    refuel: document.getElementById('refuel').checked,
                    createdBy: user.uid,
                    createdAt: serverTimestamp(),
                    dateLabel: new Date().toLocaleString('lo-LA')
                });
                this.reset();
                showToast("ບັນທຶກສຳເລັດ!");
            } catch (error) {
                showToast("ຂໍ້ຜິດພາດ");
            } finally {
                btn.disabled = false;
            }
        });

        function renderLogs() {
            const list = document.getElementById('logList');
            const emptyState = document.getElementById('emptyState');
            if (logs.length === 0) {
                emptyState.classList.remove('hidden');
                list.innerHTML = '';
                return;
            }
            emptyState.classList.add('hidden');

            list.innerHTML = logs.map(log => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-4 text-sm text-gray-600">${log.dateLabel ? log.dateLabel.split(',')[0] : '...'}</td>
                    <td class="px-4 py-4">
                        <div class="text-sm font-bold text-blue-700">${log.vehicle}</div>
                        <div class="text-xs font-medium text-gray-900">${log.driver}</div>
                        <div class="text-[10px] text-gray-400 italic">${log.purpose}</div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm text-gray-800 font-semibold">${log.distance} km</div>
                        <div class="text-[10px] text-gray-400">${log.kmStart} - ${log.kmEnd}</div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm text-red-600 font-bold">${log.fuelUsed ? log.fuelUsed.toFixed(2) : 0} L</div>
                        <div class="text-[10px] text-gray-500">${log.fuelType} (${log.fuelRate}km/L)</div>
                        ${log.refuel ? '<span class="inline-block mt-1 px-2 py-0.5 text-[10px] font-bold rounded bg-orange-100 text-orange-600 border border-orange-200">ເຕີມນ້ຳມັນ</span>' : ''}
                    </td>
                    <td class="px-4 py-4 text-right">
                        <button onclick="window.deleteLog('${log.id}')" class="text-red-400 hover:text-red-600 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats() {
            const totalDistance = logs.reduce((sum, log) => sum + (log.distance || 0), 0);
            const totalLiters = logs.reduce((sum, log) => sum + (log.fuelUsed || 0), 0);
            const totalFuelEvents = logs.filter(log => log.refuel).length;

            document.getElementById('total-trips').innerText = logs.length;
            document.getElementById('total-km').innerText = totalDistance.toLocaleString();
            document.getElementById('total-fuel-events').innerText = totalFuelEvents;
            document.getElementById('total-fuel-liters').innerText = totalLiters.toLocaleString(undefined, {maximumFractionDigits: 1});
        }

        window.deleteLog = async (id) => {
            if (confirm('ລຶບຂໍ້ມູນ?')) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vehicle_logs', id));
                    showToast("ລຶບແລ້ວ");
                } catch (e) {}
            }
        };

        window.exportData = () => {
            if (logs.length === 0) return;
            let csv = "ວັນທີ,ລົດ,ຜູ້ຂັບ,ຈຸດປະສົງ,ກິໂລເລີ່ມ,ກິໂລສິ້ນສຸດ,ໄລຍະທາງ,ປະເພດນ້ຳມັນ,ສິ້ນເປືອງ(ລິດ),ເຕີມນ້ຳມັນ\n";
            logs.forEach(l => csv += `${l.dateLabel},${l.vehicle},${l.driver},${l.purpose},${l.kmStart},${l.kmEnd},${l.distance},${l.fuelType},${l.fuelUsed.toFixed(2)},${l.refuel?'ແມ່ນ':'ບໍ່'}\n`);
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `vehicle_log_fuel_report_${new Date().getTime()}.csv`;
            a.click();
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-20');
            setTimeout(() => t.classList.add('translate-y-20'), 3000);
        }

        init();
    </script>
</body>
</html>